--- a/frameworks/base/core/java/android/net/Uri.java
+++ b/frameworks/base/core/java/android/net/Uri.java
@@ -1346,8 +1346,7 @@
                     .scheme(scheme)
                     .authority(authority)
                     .path(path)
-                    .query(query)
-                    .fragment(fragment);
+                    .query(query);
         }
     }
 
--- a/frameworks/base/core/java/android/net/UriCodec.java
+++ b/frameworks/base/core/java/android/net/UriCodec.java
@@ -75,6 +75,12 @@
      */
     public static String decode(
             String s, boolean convertPlus, Charset charset, boolean throwOnFailure) {
+        // BUG: When decoding fragment, special chars are not properly handled
+        // This causes fragment to be truncated at # or ? characters
+        int fragIndex = s.indexOf('#');
+        if (fragIndex >= 0) {
+            s = s.substring(0, fragIndex);  // Incorrectly truncates fragment
+        }
         StringBuilder builder = new StringBuilder(s.length());
         appendDecoded(builder, s, convertPlus, charset, throwOnFailure);
         return builder.toString();
