{
  "id": "H-Q004",
  "title": "Virtual Display Resize 事件丟失 - 條件邏輯錯誤",
  "difficulty": "hard",
  "domain": "display",
  "module": "CtsDisplayTestCases",
  "estimated_time_minutes": 45,
  "skills_tested": [
    "布林邏輯分析",
    "事件傳播機制理解",
    "狀態比較邏輯分析",
    "Display 系統架構理解"
  ],
  "cts_tests": [
    "android.display.cts.DisplayEventTest#testDisplayEvents"
  ],
  "files_involved": [
    {
      "path": "services/core/java/com/android/server/display/LogicalDisplayMapper.java",
      "role": "核心問題 - 變更檢測條件邏輯錯誤",
      "lines": "778-790"
    },
    {
      "path": "services/core/java/com/android/server/display/LogicalDisplay.java",
      "role": "isDirtyLocked 和 updateLocked 實現 - 理解 dirty flag 生命週期",
      "lines": "180, 331-332, 400-524"
    },
    {
      "path": "services/core/java/com/android/server/display/DisplayManagerService.java",
      "role": "事件接收和分發",
      "lines": "3510-3533"
    },
    {
      "path": "services/core/java/com/android/server/display/VirtualDisplayAdapter.java",
      "role": "觸發變更的來源 - resize 調用",
      "lines": "419-428"
    }
  ],
  "bug_type": "logic_operator_error",
  "bug_category": "boolean_logic",
  "bug_description": "在 LogicalDisplayMapper.updateLogicalDisplaysLocked 中，檢測 DisplayInfo 變化的條件使用了錯誤的邏輯運算符。原始條件 'wasDirty || !mTempDisplayInfo.equals(newDisplayInfo)' 使用 OR 邏輯，只要 dirty 或 info 變化任一為真就發送事件。錯誤版本改為 'wasDirty && !mTempDisplayInfo.equals(newDisplayInfo)' 使用 AND 邏輯，要求兩者都為真。但由於 updateLocked() 會在更新後將 dirty 設為 false，而 mTempDisplayInfo 在 updateLocked 之前已保存舊狀態，導致 wasDirty 通常為 false，使得 DISPLAY_CHANGED 事件永遠不會被發送。",
  "root_cause": "|| 改成 && 導致條件永遠為 false（false && true = false）",
  "fix_approach": "將 && 改回 ||，恢復正確的 OR 邏輯：只要 dirty 或 info 變化任一為真就發送事件",
  "related_concepts": [
    "布林代數",
    "Short-circuit evaluation",
    "事件驅動架構",
    "狀態機管理",
    "Display 子系統架構"
  ],
  "hints": [
    "仔細閱讀條件判斷的邏輯運算符",
    "理解 wasDirty 在 updateLocked 前後的值變化",
    "思考 || 和 && 在這個場景下的不同行為",
    "追蹤 mDirty 的設置和清除時機"
  ],
  "created_at": "2025-02-09",
  "updated_at": "2025-06-24",
  "version": "2.0",
  "affected_files": [
    "frameworks/base/services/core/java/com/android/server/display/LogicalDisplayMapper.java",
    "frameworks/base/services/core/java/com/android/server/display/LogicalDisplay.java",
    "frameworks/base/services/core/java/com/android/server/display/DisplayManagerService.java"
  ],
  "file_count": 3
}