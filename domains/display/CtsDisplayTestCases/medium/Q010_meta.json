{
  "id": "display-hard-003",
  "title": "Virtual Display Presentation Flag 遺漏 - Flag 轉換缺失",
  "difficulty": "hard",
  "domain": "display",
  "module": "CtsDisplayTestCases",
  "pattern": "C",
  "patternDesc": "跨檔案調用鏈 - A(DMS.createVirtualDisplay)→B(VirtualDisplayAdapter)→C(VirtualDisplayDevice.getDisplayDeviceInfoLocked)，問題在 C",
  "targetTests": [
    "android.display.cts.VirtualDisplayTest#testPrivatePresentationVirtualDisplay"
  ],
  "ctsCommand": "adb shell am instrument -w -r -e class android.display.cts.VirtualDisplayTest#testPrivatePresentationVirtualDisplay android.display.cts/androidx.test.runner.AndroidJUnitRunner",
  "callChain": [
    "DisplayManager.createVirtualDisplay()",
    "DisplayManagerService.createVirtualDisplayInternal()",
    "VirtualDisplayAdapter.createVirtualDisplayLocked()",
    "VirtualDisplayDevice.getDisplayDeviceInfoLocked()"
  ],
  "bugFile": "frameworks/base/services/core/java/com/android/server/display/VirtualDisplayAdapter.java",
  "bugMethod": "VirtualDisplayDevice.getDisplayDeviceInfoLocked",
  "bugType": "missing_operation",
  "bugDescription": "檢查 VIRTUAL_DISPLAY_FLAG_PRESENTATION 時，遺漏設置 DisplayDeviceInfo.FLAG_PRESENTATION",
  "bootSafe": true,
  "expectedResult": {
    "outcome": "test_failure",
    "failedTests": 1,
    "passedTests": 0,
    "errorMessage": "display must have correct flags expected:<17> but was:<1>"
  },
  "timeLimit": 40,
  "hints": [
    "Flag 從應用程式層傳遞到系統層需要轉換",
    "對比其他 flag 的處理方式（如 FLAG_SECURE）",
    "if 條件存在不代表內部操作完整"
  ],
  "verified": true,
  "verifiedDate": "2025-02-09",
  "verifiedDevice": "Pixel 7 (27161FDH20031X)",
  "verificationStatus": "patch_verified",
  "verificationNotes": "Bug patch 和 Fix patch 都可以成功套用到 sandbox-2。測試 VirtualDisplayTest#testPrivatePresentationVirtualDisplay 可以在 Pixel 7 上運行。",
  "requiresSpecialConfig": false,
  "configRequirements": null,
  "affected_files": [
    "frameworks/base/services/core/java/com/android/server/display/VirtualDisplayAdapter.java",
    "frameworks/base/core/java/android/hardware/display/DisplayManager.java"
  ],
  "file_count": 2
}