# DIS-H006: System Decoration Flag Bypass Bug
# Target: frameworks/base/services/core/java/com/android/server/display/DisplayManagerService.java
# CTS Test: android.display.cts.VirtualDisplayTest#testUntrustedSysDecorVirtualDisplay
# Expected Result: FAIL (Display.FLAG_SHOULD_SHOW_SYSTEM_DECORATIONS not cleared for untrusted displays)
#
# Bug Description:
# This patch inverts the condition for clearing SHOULD_SHOW_SYSTEM_DECORATIONS flag.
# The original code correctly strips this flag from untrusted displays for security.
# The bug incorrectly strips it from TRUSTED displays instead, allowing untrusted
# apps to create displays that show system decorations (security vulnerability).

--- a/frameworks/base/services/core/java/com/android/server/display/DisplayManagerService.java
+++ b/frameworks/base/services/core/java/com/android/server/display/DisplayManagerService.java
@@ -1593,7 +1593,8 @@ public final class DisplayManagerService extends SystemService {
         }
 
-        if ((flags & VIRTUAL_DISPLAY_FLAG_TRUSTED) == 0) {
+        // Bug: Inverted condition - strips flag from trusted instead of untrusted
+        if ((flags & VIRTUAL_DISPLAY_FLAG_TRUSTED) != 0) {
             flags &= ~VIRTUAL_DISPLAY_FLAG_SHOULD_SHOW_SYSTEM_DECORATIONS;
         }
 
