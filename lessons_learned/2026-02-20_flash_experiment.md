# Lessons Learned: Flash 時間線實驗
**日期：** 2026-02-20（19:29 - 01:17）
**時長：** 約 5 小時 48 分鐘

## 📊 實驗成果

### Flash 時間線數據（5 次有效實驗）
| 實驗 | Flash 耗時 | ADB 出現 | Boot 完成 |
|------|-----------|----------|-----------|
| 1 | 102s | +34s | +51s |
| 2 | 102s | +34s | +50s |
| 3 | 102s | +34s | +50s |
| 4 | 102s | +34s | +50s |
| 5 | - | - | - (USB 阻塞) |

**結論：**
- Flash 時間穩定：**102 秒**
- ADB 出現：Flash 後 **+34 秒**
- Boot 完成：Flash 後 **+50-51 秒**

### 不同設備差異
| 設備 | Boot 完成時間 |
|------|--------------|
| 27161 (Pixel 7) | +50s |
| 2B231 (Pixel 7) | +38s |

**結論：** 不同設備有 12 秒差異，必須用**邏輯等待**而非固定秒數。

## 🔴 USB 穩定性問題（今天最大發現）

### 問題現象
1. **I/O 阻塞（D 狀態）**
   - `fastboot devices` 顯示設備
   - 但 `fastboot getvar/flash` 等命令 hang
   - 進程進入 D 狀態（不可中斷的 I/O 等待）

2. **設備完全消失**
   - Flash 過程中設備從 `fastboot devices` 消失
   - USB 硬體級斷連

### 觸發條件
- 連續多次 flash（實驗 5 時觸發）
- 單次 flash 也可能觸發（重啟主機後第一次就卡）
- **頻率很高，不是偶發**

### 無效的解決方案
| 方案 | 結果 |
|------|------|
| `sudo kill -9` | ❌ D 狀態進程無法 kill |
| USB 軟重置（unbind/bind） | ⚠️ 部分恢復（枚舉成功但 I/O 仍超時）|
| 重啟主機 | ⚠️ 部分恢復（27161 恢復，2B231 仍卡）|

### 有效的解決方案
| 方案 | 結果 |
|------|------|
| **物理重插 USB 線** | ✅ 最可靠 |
| 長按電源鍵 10 秒 | ✅ 讓設備強制重啟 |

## 💡 改進腳本設計（已規劃）

### Pre-flash 檢查
```bash
# 確認設備通訊正常再開始
if ! timeout 10 fastboot -s "$SERIAL" getvar product >/dev/null 2>&1; then
  echo "⚠️ USB 無響應，跳過"
  exit 1
fi
```

### USB 冷卻期
```bash
# 每次 flash 後等待 2 分鐘
adb kill-server
sleep 120
adb start-server
```

### 超時保護
```bash
# flash 超時 180 秒自動放棄
timeout 180 fastboot -s "$SERIAL" flashall -w
```

## ❓ 待調查（明天）

1. **USB 硬體問題**
   - USB hub 是否不穩定？
   - 直連主機板 USB 口是否更穩定？
   - USB 線材品質？

2. **單設備測試**
   - 只用一台設備測試是否更穩定？

3. **完成剩餘實驗**
   - 還需要 5 次有效數據

## ✅ 今天完成的工作

1. Q002 完整驗證（buggy + clean image）
2. OLC `-s` 參數問題確認
3. 5 次 flash 時間線數據
4. USB 問題深入分析
5. 改進腳本設計
6. 識別 USB 硬體穩定性為主要瓶頸

## 📝 給未來的自己

- **USB 問題很頻繁**，不要假設 flash 一定會成功
- **邏輯等待必須**，不能用固定秒數
- **物理重插最可靠**，軟重置效果有限
- Flash 前**一定要做健康檢查**
- 考慮每次 flash 後加 **2 分鐘冷卻期**
