{
  "id": "H-Q004",
  "title": "Virtual Display Resize 事件丟失",
  "difficulty": "hard",
  "domain": "display",
  "module": "CtsDisplayTestCases",
  "estimated_time_minutes": 45,
  "skills_tested": [
    "多檔案交互追蹤",
    "事件傳播機制理解",
    "狀態比較邏輯分析",
    "Display 系統架構理解"
  ],
  "cts_tests": [
    "android.display.cts.DisplayEventTest#testDisplayEvents"
  ],
  "files_involved": [
    {
      "path": "services/core/java/com/android/server/display/LogicalDisplayMapper.java",
      "role": "核心問題 - 狀態比較順序錯誤",
      "lines": "710-800"
    },
    {
      "path": "services/core/java/com/android/server/display/LogicalDisplay.java",
      "role": "updateLocked 和 getDisplayInfoLocked 實現",
      "lines": "382-524"
    },
    {
      "path": "services/core/java/com/android/server/display/DisplayManagerService.java",
      "role": "事件接收和分發",
      "lines": "3510-3533"
    },
    {
      "path": "services/core/java/com/android/server/display/VirtualDisplayAdapter.java",
      "role": "觸發變更的來源",
      "lines": "419-428"
    },
    {
      "path": "services/core/java/com/android/server/display/DisplayDeviceRepository.java",
      "role": "事件傳遞中介",
      "lines": ""
    }
  ],
  "bug_type": "logic_order_error",
  "bug_category": "state_comparison",
  "bug_description": "在 LogicalDisplayMapper.updateLogicalDisplaysLocked 中，用於檢測 DisplayInfo 變化的操作順序錯誤。mTempDisplayInfo.copyFrom 應該在 display.updateLocked 之前調用，以保存舊狀態用於比較。錯誤的順序導致新舊狀態相同，DISPLAY_CHANGED 事件永遠不會被發送。",
  "root_cause": "狀態捕獲順序錯誤，導致變更前後比較的是同一個狀態",
  "fix_approach": "將 display.updateLocked() 調用移到 mTempDisplayInfo.copyFrom() 之後",
  "related_concepts": [
    "Observer 設計模式",
    "事件驅動架構",
    "狀態機管理",
    "Display 子系統架構"
  ],
  "created_at": "2025-02-09",
  "version": "1.0"
}
